<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-pikachu.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-pikachu.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="google-site-verification" content="-QMh-gRPduq5T_vg3_Pwi3kZsNSiyuEpPBaDIXV8J34">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"oscarcx123.github.io","root":"/","scheme":"Gemini","version":"7.7.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="最近对Unity的逆向工程比较感兴趣，于是就开始自学，并把学习心得分享在这里。 注：本篇内容仅供学习交流，请勿用于违法用途。本人所有逆向研究学习而产生的最终成品内容均不会进行发布和传播！如果你是想来下载各种破解APP的，可以点关闭了。">
<meta property="og:type" content="article">
<meta property="og:title" content="逆向工程学习记录">
<meta property="og:url" content="https://oscarcx123.github.io/tech/reverse-engineering.html">
<meta property="og:site_name" content="Azure">
<meta property="og:description" content="最近对Unity的逆向工程比较感兴趣，于是就开始自学，并把学习心得分享在这里。 注：本篇内容仅供学习交流，请勿用于违法用途。本人所有逆向研究学习而产生的最终成品内容均不会进行发布和传播！如果你是想来下载各种破解APP的，可以点关闭了。">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2019-09-03T02:06:00.000Z">
<meta property="article:modified_time" content="2020-10-23T05:45:14.752Z">
<meta property="article:author" content="oscarcx123">
<meta property="article:tag" content="hack">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://oscarcx123.github.io/tech/reverse-engineering.html">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true
  };
</script>

  <title>逆向工程学习记录 | Azure</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <link rel="stylesheet" href="/aplayer/APlayer.min.css">
  <div id="aplayer"></div>
  <script type="text/javascript" src="/aplayer/APlayer.min.js"></script>
  <script type="text/javascript" src="/aplayer/music.js"></script>
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Azure</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>

  <div class="site-nav-right"></div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
        <li class="menu-item menu-item-sitemap">

    <a href="/sitemap.xml" rel="section"><i class="fa fa-fw fa-sitemap"></i>站点地图</a>

  </li>
  </ul>

</nav>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://oscarcx123.github.io/tech/reverse-engineering.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/avatar.jpg">
      <meta itemprop="name" content="oscarcx123">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Azure">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          逆向工程学习记录
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-09-02 22:06:00" itemprop="dateCreated datePublished" datetime="2019-09-02T22:06:00-04:00">2019-09-02</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/tech/" itemprop="url" rel="index">
                    <span itemprop="name">技术</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>6.9k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>6 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>最近对Unity的逆向工程比较感兴趣，于是就开始自学，并把学习心得分享在这里。</p>
<p>注：本篇内容仅供学习交流，请勿用于违法用途。本人所有逆向研究学习而产生的最终成品内容均不会进行发布和传播！如果你是想来下载各种破解APP的，可以点关闭了。</p>
<a id="more"></a>

<h2 id="0x00-软件清单"><a href="#0x00-软件清单" class="headerlink" title="0x00 软件清单"></a>0x00 软件清单</h2><p>操作环境如下：</p>
<ul>
<li>Windows 10 (Build 18362)</li>
<li>JDK 12.0.2</li>
<li>IDA pro 7.2 (这个自行解决，IDA普通版不清楚是否可行)</li>
<li>dnSpy v6.0.5 (64-bit)</li>
<li>HxD 2.3.0.0</li>
<li>apktool 2.4.0</li>
</ul>
<h2 id="0x01-旅行青蛙-v1-0-4-2019-09-02"><a href="#0x01-旅行青蛙-v1-0-4-2019-09-02" class="headerlink" title="0x01 旅行青蛙 v1.0.4 (2019/09/02)"></a>0x01 旅行青蛙 v1.0.4 (2019/09/02)</h2><p>我在进行逆向的过程参考了<a target="_blank" rel="noopener" href="http://www.alonemonkey.com/2018/02/02/unity-reverse-android/">《旅行的青蛙Unity游戏逆向修改–Android篇》</a>这篇非常棒的文章，现在将要点提炼在下方。</p>
<ol start="0">
<li>获取旅行青蛙1.0.4版本</li>
</ol>
<p>网上一搜一大把，我下载之后重命名为<code>frog_104.apk</code></p>
<ol>
<li>首先将apk用<code>apktool</code>进行反编译</li>
</ol>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar apktool.jar d frog_104.apk</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>找到Assembly-CSharp.dll</li>
</ol>
<p>查看<code>assets/bin/Data/Managed</code>文件夹下面的dll文件，其中<code>Assembly-CSharp.dll</code>便是游戏中的C#脚本</p>
<ol start="3">
<li>使用dnSpy反编译找到的C#脚本</li>
</ol>
<p>这个不用多说，把dll拖入dnSpy即可。左侧是对应的类，点击类就可以看到反编译出来的代码，然后根据游戏里面的一些特征来分析反编译出来的脚本。</p>
<ol start="4">
<li>汉化（替换游戏中字符串）</li>
</ol>
<p>没有看到下方的搜索框的话，点击<code>编辑-&gt;搜索程序集</code>。</p>
<p>搜索需要替换的关键字词（例如“名前”），搜索时选择“数字/字符串”。搜索结果可以直接双击进去查看内容。</p>
<p>这里搜索出来的是<code>CallTutorial</code>方法，下面是节选的一部分。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> Step.a2_MO_GoHome:</span><br><span class="line">&#123;</span><br><span class="line">	component4.Frog.SetActive(<span class="literal">true</span>);</span><br><span class="line">	UI_Cmp.FrogCursorUI.SetActive(<span class="literal">false</span>);</span><br><span class="line">	<span class="keyword">this</span>.seTime = <span class="number">0f</span>;</span><br><span class="line">	HelpPanel help = UI_Cmp.HelpUI.GetComponent&lt;HelpPanel&gt;();</span><br><span class="line">	help.OpenPanel(<span class="string">&quot;かえるがいます\n名前をつけてあげましょう&quot;</span>);</span><br><span class="line">	help.ResetOnClick_Screen();</span><br><span class="line">	help.SetOnClick_Screen(<span class="built_in">delegate</span></span><br><span class="line">	&#123;</span><br><span class="line">		help.ClosePanel();</span><br><span class="line">	&#125;);</span><br><span class="line">	help.SetOnClick_Screen(<span class="built_in">delegate</span></span><br><span class="line">	&#123;</span><br><span class="line">		UI_Cmp.blockUI(<span class="literal">true</span>, <span class="keyword">new</span> Color(<span class="number">0f</span>, <span class="number">0f</span>, <span class="number">0f</span>, <span class="number">0f</span>));</span><br><span class="line">	&#125;);</span><br><span class="line">	help.SetOnClick_Screen(<span class="built_in">delegate</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">this</span>.seTime = <span class="number">-1E-06</span>f;</span><br><span class="line">	&#125;);</span><br><span class="line">	help.SetOnClick_Screen(<span class="built_in">delegate</span></span><br><span class="line">	&#123;</span><br><span class="line">		UI_Cmp.FrogCursorUI.SetActive(<span class="literal">false</span>);</span><br><span class="line">	&#125;);</span><br><span class="line">	<span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改需要鼠标点击对应代码，选择<code>编辑IL指令</code>，然后直接修改对应字符串即可。</p>
<ol start="5">
<li>修改三叶草数</li>
</ol>
<p>要修改三叶草数可以从购买的时候入手，比如提示三叶草不足的时候！</p>
<p>直接搜索对应字符串（这里搜索“足”）找到代码</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (SuperGameMaster.CloverPointStock() &gt;= itemDataFormat.price)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (SuperGameMaster.FindItemStock(shopDataFormat.itemId) &lt; <span class="number">99</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">base</span>.GetComponent&lt;FlickCheaker&gt;().stopFlick(<span class="literal">true</span>);</span><br><span class="line">        ConfilmPanel confilm = <span class="keyword">this</span>.ConfilmUI.GetComponent&lt;ConfilmPanel&gt;();</span><br><span class="line">        <span class="keyword">if</span> (itemDataFormat.type == Item.Type.LunchBox)</span><br><span class="line">        &#123;</span><br><span class="line">            confilm.OpenPanel_YesNo(<span class="built_in">string</span>.Concat(<span class="keyword">new</span> <span class="built_in">object</span>[]</span><br><span class="line">            &#123;</span><br><span class="line">                itemDataFormat.name,</span><br><span class="line">                <span class="string">&quot;\nを買いますか？\n（所持数\u3000&quot;</span>,</span><br><span class="line">                SuperGameMaster.FindItemStock(shopDataFormat.itemId),</span><br><span class="line">                <span class="string">&quot;）&quot;</span></span><br><span class="line">            &#125;));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            confilm.OpenPanel_YesNo(itemDataFormat.name + <span class="string">&quot;\nを買いますか？&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        confilm.ResetOnClick_Yes();</span><br><span class="line">        confilm.SetOnClick_Yes(<span class="built_in">delegate</span></span><br><span class="line">        &#123;</span><br><span class="line">            confilm.ClosePanel();</span><br><span class="line">        &#125;);</span><br><span class="line">        confilm.SetOnClick_Yes(<span class="built_in">delegate</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">this</span>.GetComponent&lt;FlickCheaker&gt;().stopFlick(<span class="literal">false</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">        confilm.SetOnClick_Yes(<span class="built_in">delegate</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">this</span>.BuyItem();</span><br><span class="line">        &#125;);</span><br><span class="line">        confilm.ResetOnClick_No();</span><br><span class="line">        confilm.SetOnClick_No(<span class="built_in">delegate</span></span><br><span class="line">        &#123;</span><br><span class="line">            confilm.ClosePanel();</span><br><span class="line">        &#125;);</span><br><span class="line">        confilm.SetOnClick_No(<span class="built_in">delegate</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">this</span>.GetComponent&lt;FlickCheaker&gt;().stopFlick(<span class="literal">false</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">base</span>.GetComponent&lt;FlickCheaker&gt;().stopFlick(<span class="literal">true</span>);</span><br><span class="line">        ConfilmPanel confilm = <span class="keyword">this</span>.ConfilmUI.GetComponent&lt;ConfilmPanel&gt;();</span><br><span class="line">        confilm.OpenPanel(<span class="string">&quot;みつ葉が足りません&quot;</span>);</span><br><span class="line">        confilm.ResetOnClick_Screen();</span><br><span class="line">        confilm.SetOnClick_Screen(<span class="built_in">delegate</span></span><br><span class="line">        &#123;</span><br><span class="line">            confilm.ClosePanel();</span><br><span class="line">        &#125;);</span><br><span class="line">        confilm.SetOnClick_Screen(<span class="built_in">delegate</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">this</span>.GetComponent&lt;FlickCheaker&gt;().stopFlick(<span class="literal">false</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>关键在于进行比较的<code>SuperGameMaster.CloverPointStock()</code>，点进去查看</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">int</span> <span class="title">CloverPointStock</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> SuperGameMaster.saveData.CloverPoint;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里是获取玩家三叶草数量，我直接修改成<code>return 9999</code>即可。</p>
<p>进入<code>编辑IL指令</code>，因为只需要两条指令，所以删去多余的指令，然后指令1的操作码应为<code>idc.i4</code>，操作符是9999，指令2就是<code>ret</code>，不需要改动。</p>
<p>修改之后每次读取玩家三叶草数量，都会返回9999</p>
<ol start="6">
<li>修改抽奖券</li>
</ol>
<p>跟修改三叶草数方法一模一样</p>
<ol start="7">
<li>修改抽奖概率</li>
</ol>
<p>搜索<code>白玉</code>找到如下代码</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> Dictionary&lt;Rank, <span class="built_in">string</span>&gt; PrizeBallName = <span class="keyword">new</span> Dictionary&lt;Rank, <span class="built_in">string</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line">    &#123;</span><br><span class="line">        Rank.White,</span><br><span class="line">        <span class="string">&quot;白玉&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        Rank.Blue,</span><br><span class="line">        <span class="string">&quot;青玉&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        Rank.Green,</span><br><span class="line">        <span class="string">&quot;緑玉&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        Rank.Red,</span><br><span class="line">        <span class="string">&quot;赤玉&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        Rank.Gold,</span><br><span class="line">        <span class="string">&quot;黄玉&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>右键点击<code>PrizeBallName</code>选择“分析”找到在哪里被读取的，然后就会找出<code>PushRollButton</code>方法。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">PushRollButton</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (SuperGameMaster.TicketStock() &lt; <span class="number">5</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        ConfilmPanel confilm = <span class="keyword">this</span>.ConfilmUI.GetComponent&lt;ConfilmPanel&gt;();</span><br><span class="line">        confilm.OpenPanel(<span class="string">&quot;ふくびき券が足りません&quot;</span>);</span><br><span class="line">        confilm.ResetOnClick_Screen();</span><br><span class="line">        confilm.SetOnClick_Screen(<span class="built_in">delegate</span></span><br><span class="line">        &#123;</span><br><span class="line">            confilm.ClosePanel();</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    SuperGameMaster.GetTicket(<span class="number">-5</span>);</span><br><span class="line">    SuperGameMaster.set_FlagAdd(Flag.Type.ROLL_NUM, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">base</span>.GetComponentInParent&lt;UIMaster&gt;().freezeObject(<span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">base</span>.GetComponentInParent&lt;UIMaster&gt;().blockUI(<span class="literal">true</span>, <span class="keyword">new</span> Color(<span class="number">0f</span>, <span class="number">0f</span>, <span class="number">0f</span>, <span class="number">0.3f</span>));</span><br><span class="line">    <span class="keyword">this</span>.LotteryCheck();</span><br><span class="line">    <span class="keyword">this</span>.ResultButton.GetComponent&lt;RollResultButton&gt;().CngImage((<span class="built_in">int</span>)<span class="keyword">this</span>.result);</span><br><span class="line">    <span class="keyword">this</span>.ResultButton.GetComponent&lt;RollResultButton&gt;().CngResultText(Define.PrizeBallName[<span class="keyword">this</span>.result] + <span class="string">&quot;がでました&quot;</span>);</span><br><span class="line">    <span class="keyword">this</span>.LotteryWheelPanel.GetComponent&lt;LotteryWheelPanel&gt;().OpenPanel(<span class="keyword">this</span>.result);</span><br><span class="line">    SuperGameMaster.SetTmpRaffleResult((<span class="built_in">int</span>)<span class="keyword">this</span>.result);</span><br><span class="line">    SuperGameMaster.SaveData();</span><br><span class="line">    SuperGameMaster.audioMgr.PlaySE(Define.SEDict[<span class="string">&quot;SE_Raffle&quot;</span>]);</span><br><span class="line">    <span class="keyword">this</span>.BackFunc();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>PushRollButton</code>方法中找出下面这行代码，其中调用了<code>PrizeBallName</code>。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.ResultButton.GetComponent&lt;RollResultButton&gt;().CngResultText(Define.PrizeBallName[<span class="keyword">this</span>.result] + <span class="string">&quot;がでました&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>看到<code>Define.PrizeBallName[this.result]</code>，就右键单击<code>result</code>，分析，点开“被赋值于”，可以看到<code>RaffelPanel.LotteryCheck()</code>和<code>RaffelPanel.SetTmpResult()</code>方法，分别双击点开。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">LotteryCheck</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>	&#123;</span><br><span class="line">		<span class="built_in">int</span> num = UnityEngine.Random.Range(<span class="number">0</span>, Define.PrizeBalls[Rank.RankMax]);</span><br><span class="line">		<span class="keyword">this</span>.result = Rank.White;</span><br><span class="line">		<span class="built_in">int</span> i = <span class="number">0</span>;</span><br><span class="line">		<span class="built_in">int</span> num2 = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">while</span> (i &lt; <span class="number">5</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			num2 += Define.PrizeBalls[(Rank)i];</span><br><span class="line">			<span class="keyword">if</span> (num &lt; num2)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">this</span>.result = (Rank)i;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			i++;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SetTmpResult</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>	&#123;</span><br><span class="line">		<span class="keyword">this</span>.result = (Rank)SuperGameMaster.GetTmpRaffleResult();</span><br><span class="line">		<span class="keyword">this</span>.BackFunc();</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>看名字很明显应该是<code>RaffelPanel.LotteryCheck()</code>，其中<code>PrizeBalls</code>应该就放了概率了，点开查看</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> Dictionary&lt;Rank, <span class="built_in">int</span>&gt; PrizeBalls = <span class="keyword">new</span> Dictionary&lt;Rank, <span class="built_in">int</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line">    &#123;</span><br><span class="line">        Rank.White,</span><br><span class="line">        <span class="number">60</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        Rank.Blue,</span><br><span class="line">        <span class="number">27</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        Rank.Green,</span><br><span class="line">        <span class="number">9</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        Rank.Red,</span><br><span class="line">        <span class="number">3</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        Rank.Gold,</span><br><span class="line">        <span class="number">1</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        Rank.RankMax,</span><br><span class="line">        <span class="number">100</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>到这里应该就没有难度了。</p>
<ol start="8">
<li>修改农场四叶草数</li>
</ol>
<p>这次直接搜索关键词<code>clover</code>。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">checkCloverCreate</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.cloverList = SuperGameMaster.GetCloverList();</span><br><span class="line">    <span class="built_in">bool</span> flag = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.cloverList.Count == <span class="number">0</span>)  </span><br><span class="line">    &#123;</span><br><span class="line">        flag = <span class="literal">true</span>;</span><br><span class="line">        <span class="comment">//这句话翻译的意思就是:有了四叶草的初期化标志。四叶草生成</span></span><br><span class="line">        <span class="comment">//也就是flag为true的时候会生成四叶草</span></span><br><span class="line">        Debug.Log(<span class="string">&quot;[CloverFarm] クローバーの初期化フラグが立ちました。四葉を生成します&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.cloverList.Count &lt; <span class="keyword">this</span>.cloverMax)</span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(<span class="built_in">string</span>.Concat(<span class="keyword">new</span> <span class="built_in">object</span>[]</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;[CloverFarm] クローバーの数を調整します：&quot;</span>,</span><br><span class="line">            <span class="keyword">this</span>.cloverList.Count,</span><br><span class="line">            <span class="string">&quot; &gt; &quot;</span>,</span><br><span class="line">            <span class="keyword">this</span>.cloverMax</span><br><span class="line">        &#125;));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">this</span>.cloverList.Count &lt; <span class="keyword">this</span>.cloverMax)</span><br><span class="line">    &#123;</span><br><span class="line">        CloverDataFormat cloverDataFormat = <span class="keyword">new</span> CloverDataFormat();</span><br><span class="line">        cloverDataFormat.lastHarvest = <span class="keyword">new</span> DateTime(<span class="number">1970</span>, <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">        cloverDataFormat.timeSpanSec = -<span class="keyword">this</span>.cloverList.Count - <span class="number">1</span>;</span><br><span class="line">        cloverDataFormat.newFlag = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">this</span>.cloverList.Add(cloverDataFormat);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.cloverList.Count &gt; <span class="keyword">this</span>.cloverMax)</span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(<span class="built_in">string</span>.Concat(<span class="keyword">new</span> <span class="built_in">object</span>[]</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;[CloverFarm] クローバーの数を調整します：&quot;</span>,</span><br><span class="line">            <span class="keyword">this</span>.cloverList.Count,</span><br><span class="line">            <span class="string">&quot; &gt; &quot;</span>,</span><br><span class="line">            <span class="keyword">this</span>.cloverMax</span><br><span class="line">        &#125;));</span><br><span class="line">        <span class="keyword">this</span>.cloverList.RemoveRange(<span class="keyword">this</span>.cloverMax - <span class="number">1</span>, <span class="keyword">this</span>.cloverList.Count - <span class="keyword">this</span>.cloverMax);</span><br><span class="line">    &#125;</span><br><span class="line">    List&lt;GameObject&gt; list = <span class="keyword">new</span> List&lt;GameObject&gt;();</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.cloverList.Count; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">this</span>.cloverList[i].newFlag &amp;&amp; <span class="keyword">this</span>.cloverList[i].timeSpanSec &lt;= <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            list.Add(<span class="keyword">this</span>.LoadCloverObject(i, <span class="keyword">this</span>.cloverList[i]));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">int</span> num = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> j = <span class="number">0</span>; j &lt; <span class="keyword">this</span>.cloverList.Count; j++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.cloverList[j].newFlag)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//这里根据flag调用不同的函数，</span></span><br><span class="line">            <span class="keyword">if</span> (!flag)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//生成三叶草</span></span><br><span class="line">                list.Add(<span class="keyword">this</span>.NewCloverObject(j, <span class="keyword">this</span>.cloverList[j], list));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//生成四叶草，不同的是第四个参数为true</span></span><br><span class="line">                list.Add(<span class="keyword">this</span>.NewCloverObject(j, <span class="keyword">this</span>.cloverList[j], list, <span class="literal">true</span>));</span><br><span class="line">                flag = <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">this</span>.cloverList[j].x = list[list.Count - <span class="number">1</span>].transform.localPosition.x;</span><br><span class="line">            <span class="keyword">this</span>.cloverList[j].y = list[list.Count - <span class="number">1</span>].transform.localPosition.y;</span><br><span class="line">            Clover component = list[list.Count - <span class="number">1</span>].GetComponent&lt;Clover&gt;();</span><br><span class="line">            <span class="keyword">this</span>.cloverList[j].element = component.element;</span><br><span class="line">            <span class="keyword">this</span>.cloverList[j].spriteNum = component.spriteNum;</span><br><span class="line">            <span class="keyword">this</span>.cloverList[j].point = component.point;</span><br><span class="line">            <span class="keyword">this</span>.cloverList[j].newFlag = <span class="literal">false</span>;</span><br><span class="line">            num++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">foreach</span> (GameObject gameObject <span class="keyword">in</span> list)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">int</span> num2 = <span class="keyword">this</span>.cloverOrderInLayer;</span><br><span class="line">        <span class="keyword">foreach</span> (GameObject gameObject2 <span class="keyword">in</span> list)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (gameObject.transform.position.y &lt; gameObject2.transform.position.y)</span><br><span class="line">            &#123;</span><br><span class="line">                num2++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        gameObject.GetComponent&lt;SpriteRenderer&gt;().sortingOrder = num2;</span><br><span class="line">    &#125;</span><br><span class="line">    Debug.Log(<span class="built_in">string</span>.Concat(<span class="keyword">new</span> <span class="built_in">object</span>[]</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;[CloverFarm] クローバー生成完了：&quot;</span>,</span><br><span class="line">        list.Count,</span><br><span class="line">        <span class="string">&quot;\u3000/ (新規：&quot;</span>,</span><br><span class="line">        num,</span><br><span class="line">        <span class="string">&quot;)&quot;</span></span><br><span class="line">    &#125;));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中<code>this.NewCloverObject(j, this.cloverList[j], list)</code>就是生成新草的方法，跟进去看看</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> GameObject <span class="title">NewCloverObject</span>(<span class="params"><span class="built_in">int</span> index, CloverDataFormat cloverData, List&lt;GameObject&gt; cloversObj</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.NewCloverObject(index, cloverData, cloversObj, <span class="literal">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>继续跟。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> GameObject <span class="title">NewCloverObject</span>(<span class="params"><span class="built_in">int</span> index, CloverDataFormat cloverData, List&lt;GameObject&gt; cloversObj, <span class="built_in">bool</span> fourLeafFlag</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Vector2 size = <span class="keyword">base</span>.GetComponent&lt;BoxCollider2D&gt;().size;</span><br><span class="line">    PolygonCollider2D component = <span class="keyword">base</span>.GetComponent&lt;PolygonCollider2D&gt;();</span><br><span class="line">    Vector2 vector;</span><br><span class="line">    vector..ctor(<span class="keyword">base</span>.GetComponent&lt;BoxCollider2D&gt;().offset.x - size.x / <span class="number">2f</span>, <span class="keyword">base</span>.GetComponent&lt;BoxCollider2D&gt;().offset.y - size.y / <span class="number">2f</span>);</span><br><span class="line">    <span class="built_in">int</span> num = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">bool</span> flag;</span><br><span class="line">    Vector3 vector2;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">        flag = <span class="literal">false</span>;</span><br><span class="line">        vector2 = <span class="keyword">new</span> Vector2(vector.x + Random.Range(<span class="number">0f</span>, size.x), vector.y + Random.Range(<span class="number">0f</span>, size.y));</span><br><span class="line">        <span class="keyword">if</span> (!component.OverlapPoint(vector2 + <span class="keyword">base</span>.transform.position))</span><br><span class="line">        &#123;</span><br><span class="line">            flag = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; cloversObj.Count; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                Vector2 size2 = cloversObj[i].GetComponent&lt;BoxCollider2D&gt;().size;</span><br><span class="line">                <span class="keyword">if</span> (Mathf.Abs(vector2.x - cloversObj[i].transform.localPosition.x) &lt; size2.x / <span class="number">2f</span> &amp;&amp; Mathf.Abs(vector2.y - cloversObj[i].transform.localPosition.y) &lt; size2.y / <span class="number">4f</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    flag = <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            num++;</span><br><span class="line">            <span class="keyword">if</span> (num &gt;= <span class="number">100</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> (flag);</span><br><span class="line">    GameObject gameObject = Object.Instantiate&lt;GameObject&gt;(<span class="keyword">this</span>.basePrefab, Vector3.zero, Quaternion.identity);</span><br><span class="line">    CloverDataFormat cloverDataFormat = <span class="keyword">new</span> CloverDataFormat();</span><br><span class="line">    cloverDataFormat.point = <span class="number">1</span>;</span><br><span class="line">    cloverDataFormat.element = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//如果第四个参数是false，这里就是四叶草生成的概率，是fourLeaf_percent是1那这个概率就是1/100</span></span><br><span class="line">    <span class="keyword">if</span> (Random.Range(<span class="number">0f</span>, <span class="number">10000f</span>) &lt; <span class="keyword">this</span>.fourLeaf_percent * <span class="number">100f</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        cloverDataFormat.element = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//如果传了这个参数为true直接生成四叶草</span></span><br><span class="line">    <span class="keyword">if</span> (fourLeafFlag)</span><br><span class="line">    &#123;</span><br><span class="line">        cloverDataFormat.element = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">int</span> element = cloverDataFormat.element;</span><br><span class="line">    <span class="keyword">if</span> (element != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (element == <span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            cloverDataFormat.spriteNum = Random.Range(<span class="number">0</span>, <span class="keyword">this</span>.fourCloverSprite.Length);</span><br><span class="line">            gameObject.GetComponent&lt;SpriteRenderer&gt;().sprite = <span class="keyword">this</span>.fourCloverSprite[cloverDataFormat.spriteNum];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        cloverDataFormat.spriteNum = Random.Range(<span class="number">0</span>, <span class="keyword">this</span>.cloverSprite.Length);</span><br><span class="line">        gameObject.GetComponent&lt;SpriteRenderer&gt;().sprite = <span class="keyword">this</span>.cloverSprite[cloverDataFormat.spriteNum];</span><br><span class="line">    &#125;</span><br><span class="line">    gameObject.GetComponent&lt;Clover&gt;().SetCloverData(index, cloverDataFormat);</span><br><span class="line">    gameObject.transform.parent = <span class="keyword">base</span>.transform;</span><br><span class="line">    gameObject.transform.localScale = Vector3.one;</span><br><span class="line">    gameObject.transform.localPosition = vector2;</span><br><span class="line">    <span class="keyword">return</span> gameObject;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里有两种方法，一种改概率，一种直接永远为true。</p>
<p>这里重点看改true的方法</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//如果传了这个参数为true直接生成四叶草</span></span><br><span class="line"><span class="keyword">if</span> (fourLeafFlag)</span><br><span class="line">&#123;</span><br><span class="line">    cloverDataFormat.element = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里首先取<code>fourLeafFlag</code>判断然后跳转，所以修改为<code>true</code>即可。修改<code>ldarg.s fourLeafFlag</code>为<code>ldc.i4 1</code>，修改后的代码如下:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="literal">true</span>)</span><br><span class="line">&#123;</span><br><span class="line">    cloverDataFormat.element = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注：值得一提的是，<code>idc.i4 1</code>是true，<code>idc.i4 0</code>是false。</p>
<ol start="9">
<li>保存修改成果</li>
</ol>
<p>文件 &gt; 保存模块 &gt; 确定</p>
<ol start="10">
<li>apktool重新打包</li>
</ol>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar apktool.jar b ./frog_104</span><br></pre></td></tr></table></figure>

<ol start="11">
<li>签名</li>
</ol>
<p>这个时候安装APP会提示“该软件包似乎已损坏”，这是因为还没签名。</p>
<p>不要使用<code>signapk.jar</code>这个工具，因为它只支持到JDK 8。</p>
<p>直接在cmd中使用jdk自带的<code>jarsigner</code>即可。</p>
<p>但是，在首次使用之前，需要生成一个自己的key。</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">keytool -genkey -alias myKeyStore -keyalg RSA -validity <span class="number">20000</span> -keystore myKeyStore</span><br></pre></td></tr></table></figure>

<p>内容都可以随意填写，“密钥库口令”得记住，后面要用到。最后会询问“内容是否正确”，输入<code>y</code>即可。</p>
<p>生成密钥文件之后，可以进行签名了，这里会被要求输入刚才的“密钥库口令”。</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jarsigner -verbose -keystore myKeyStore -signedjar frog_104_signed.apk frog_104.apk myKeyStore</span><br></pre></td></tr></table></figure>

<p>签名完成之后，就可以安装APP了。</p>
<ol start="12">
<li>收获</li>
</ol>
<p>通过这次简单的逆向之旅，我初步了解了简易的逆向过程以及逆向工具的使用。</p>
<ol start="13">
<li>参考链接</li>
</ol>
<ul>
<li><p><a target="_blank" rel="noopener" href="http://www.alonemonkey.com/2018/02/02/unity-reverse-android/">旅行的青蛙Unity游戏逆向修改–Android篇</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44058342/article/details/87940908">简单Unity3D类安卓游戏逆向思路</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/47095088/signapk-jar-giving-error-java-lang-classnotfoundexception-sun-misc-base64encode/47139732">Signapk.jar giving error java.lang.ClassNotFoundException: sun.misc.BASE64Encoder
</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://blog.51cto.com/sunzeduo/1438368">用jarsigner对android apk进行签名</a></p>
</li>
</ul>
<h2 id="0x02-旅行青蛙-v1-6-2-2019-09-03"><a href="#0x02-旅行青蛙-v1-6-2-2019-09-03" class="headerlink" title="0x02 旅行青蛙 v1.6.2 (2019/09/03)"></a>0x02 旅行青蛙 v1.6.2 (2019/09/03)</h2><p>虽然还是旅行青蛙，但是这次要攻克的是它的最新版本 v1.6.2（于2019-06-24发布）。显然，这次难度会比上次要大一些。</p>
<ol start="0">
<li>获取旅行青蛙1.6.2版本</li>
</ol>
<p>网上一搜一大把，我下载之后重命名为<code>frog_162.apk</code></p>
<ol>
<li>首先将apk用<code>apktool</code>进行反编译</li>
</ol>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar apktool.jar d frog_162.apk</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>找到Assembly-CSharp.dll</li>
</ol>
<p>嗯？这次在<code>assets/bin/Data/Managed</code>下面怎么没找到<code>Assembly-CSharp.dll</code>？</p>
<p>因为之前也看过一些逆向文章，很快就认出这个是IL2cpp打包过的游戏。</p>
<p>IL2cpp打包特征有两个：</p>
<ul>
<li>在<code>assets/bin/Data/Managed/Metadata</code>下面找到<code>global-metadata.dat</code>。</li>
<li>在<code>lib/arm64-v8a</code>下面找到<code>libil2cpp.so</code>。除了<code>arm64-v8a</code>还可以是<code>armeabi-v7a</code>，<code>x86</code>等等。</li>
</ul>
<ol start="3">
<li>使用Il2CppDumper还原信息</li>
</ol>
<p>双击运行Il2CppDumper.exe程序，先选择<code>libil2cpp.so</code>文件，再选择<code>global-metadata.dat</code>文件。</p>
<p>Unity版本写<code>2018.3</code>，选择模式3，如下所示。</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Input Unity version:</span><br><span class="line"><span class="number">2018</span>.<span class="number">3</span></span><br><span class="line">Initializing metadata...</span><br><span class="line">Select <span class="built_in">Mode</span>: <span class="number">1</span>.Manual <span class="number">2</span>.Auto <span class="number">3</span>.Auto(Plus) <span class="number">4</span>.Auto(Symbol)</span><br><span class="line">Initializing il2cpp file...</span><br><span class="line">Applying relocations...</span><br><span class="line">Searching...</span><br><span class="line">CodeRegistration : ea5158</span><br><span class="line">MetadataRegistration : ea51c8</span><br><span class="line">Dumping...</span><br><span class="line">Done !</span><br><span class="line">Create DummyDll...</span><br><span class="line">Done !</span><br><span class="line">Press any key to <span class="keyword">exit</span>...</span><br></pre></td></tr></table></figure>

<p>在同一个目录下会生成<code>DummyDll</code>这个文件夹，以及<code>dump.cs</code>和<code>script.py</code>两个文件。</p>
<ol start="4">
<li>用IDA打开<code>libil2cpp.so</code>文件</li>
</ol>
<p>这个没啥好说，就是在打开文件之后记得加载（File &gt; Script File）<code>script.py</code>。IDA分析需要一段时间，所以就先让它挂着跑，我去干别的。</p>
<ol start="5">
<li>使用文本编辑器打开<code>dump.cs</code></li>
</ol>
<p>这里不使用dnSpy反编译找到的C#脚本，因为这些脚本实际上没啥用。</p>
<p>然后就开始搜索关键词了，实际上为了效率，可以利用前面1.0.4版本的未加密C#脚本来搜寻目标，但是现在是学习钻研逆向，当然不能偷懒。</p>
<p>这里想修改三叶草的数量，那就搜索关键词<code>clover</code>，翻一翻就会发现有个方法叫做<code>getCloverPoint</code>，下面内容节选自<code>dump.cs</code></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> DateTime <span class="title">Get_LoadDeviceTime</span>(<span class="params"></span>)</span>; <span class="comment">// RVA: 0x49C504 Offset: 0x49C504</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> DateTime <span class="title">GetLastDateTime</span>(<span class="params"></span>)</span>; <span class="comment">// RVA: 0x49C724 Offset: 0x49C724</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">float</span> <span class="title">getGameTimer</span>(<span class="params"></span>)</span>; <span class="comment">// RVA: 0x49C870 Offset: 0x49C870</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Scenes <span class="title">GetNowScenes</span>(<span class="params"></span>)</span>; <span class="comment">// RVA: 0x49C8D8 Offset: 0x49C8D8</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setNextScene</span>(<span class="params">Scenes _NextScene</span>)</span>; <span class="comment">// RVA: 0x499B2C Offset: 0x499B2C</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">SetStartScene</span>(<span class="params">Scenes setScene</span>)</span>; <span class="comment">// RVA: 0x49C940 Offset: 0x49C940</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">GetIAPCallBackCntEnable</span>(<span class="params"></span>)</span>; <span class="comment">// RVA: 0x49C9AC Offset: 0x49C9AC</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">IAPCallBackCntReset</span>(<span class="params"></span>)</span>; <span class="comment">// RVA: 0x49CA2C Offset: 0x49CA2C</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">IAPCallBackCntUse</span>(<span class="params"></span>)</span>; <span class="comment">// RVA: 0x49CAA8 Offset: 0x49CAA8</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">MathTime_Clover</span>(<span class="params"><span class="built_in">int</span> addTimer</span>)</span>; <span class="comment">// RVA: 0x49CB40 Offset: 0x49CB40</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> List`<span class="number">1</span>&lt;CloverDataFormat&gt; GetCloverList(); <span class="comment">// RVA: 0x49D184 Offset: 0x49D184</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">SaveCloverList</span>(<span class="params">List`<span class="number">1</span>&lt;CloverDataFormat&gt; cloverList</span>)</span>; <span class="comment">// RVA: 0x49D36C Offset: 0x49D36C</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">getCloverPoint</span>(<span class="params"><span class="built_in">int</span> num</span>)</span>; <span class="comment">// RVA: 0x49D534 Offset: 0x49D534</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">int</span> <span class="title">CloverPointStock</span>(<span class="params"></span>)</span>; <span class="comment">// RVA: 0x49ADC0 Offset: 0x49ADC0</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">int</span> <span class="title">TicketStock</span>(<span class="params"></span>)</span>; <span class="comment">// RVA: 0x49AEB0 Offset: 0x49AEB0</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">GetTicket</span>(<span class="params"><span class="built_in">int</span> getTicket</span>)</span>; <span class="comment">// RVA: 0x49D99C Offset: 0x49D99C</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">int</span> <span class="title">GetTmpRaffleResult</span>(<span class="params"></span>)</span>; <span class="comment">// RVA: 0x49DB24 Offset: 0x49DB24</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">SetTmpRaffleResult</span>(<span class="params"><span class="built_in">int</span> _val</span>)</span>; <span class="comment">// RVA: 0x49DB9C Offset: 0x49DB9C</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">int</span> <span class="title">CouponStock</span>(<span class="params"></span>)</span>; <span class="comment">// RVA: 0x49AE38 Offset: 0x49AE38</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">GetCoupon</span>(<span class="params"><span class="built_in">int</span> getCoupon</span>)</span>; <span class="comment">// RVA: 0x49DC18 Offset: 0x49DC18</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">int</span> <span class="title">RequestCountStock</span>(<span class="params"></span>)</span>; <span class="comment">// RVA: 0x49DDA4 Offset: 0x49DDA4</span></span><br></pre></td></tr></table></figure>

<p>之前我的方向就出现了错误。我选择了<code>CloverPointStock()</code>这个方法来修改，但是后来却发现特别难弄。道理就是修改这个函数的返回值为一个固定数值，我感觉思路是对的，但是改了几次都没有成功，估计是技术还不过关吧，于是果断放弃，选择了后来证明可行的办法。</p>
<p>因此，要的就是下面这一行。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">getCloverPoint</span>(<span class="params"><span class="built_in">int</span> num</span>)</span>; <span class="comment">// RVA: 0x49D534 Offset: 0x49D534</span></span><br></pre></td></tr></table></figure>

<p>Offset要记下来，下面要用到。</p>
<ol start="6">
<li>在IDA中定位对应代码</li>
</ol>
<p>在IDA中按G键（或者Jump &gt; Jump to address），然后输入刚才得到的Offset（本例中就是0x49D534），就可以定位到代码了。</p>
<p>此时看到下面内容（这里节选一段）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">; Attributes: bp-based frame</span><br><span class="line"></span><br><span class="line">SuperGameMaster$$getCloverPoint</span><br><span class="line"></span><br><span class="line">var_20&#x3D; -0x20</span><br><span class="line">var_10&#x3D; -0x10</span><br><span class="line">var_s0&#x3D;  0</span><br><span class="line"></span><br><span class="line">; __unwind &#123;</span><br><span class="line">STP             X22, X21, [SP,#-0x10+var_20]!</span><br><span class="line">STP             X20, X19, [SP,#0x20+var_10]</span><br><span class="line">STP             X29, X30, [SP,#0x20+var_s0]</span><br><span class="line">ADD             X29, SP, #0x20</span><br><span class="line">ADRP            X20, #byte_F48D6A@PAGE</span><br><span class="line">LDRB            W8, [X20,#byte_F48D6A@PAGEOFF]</span><br><span class="line">MOV             W19, W0</span><br><span class="line">TBNZ            W8, #0, loc_49D56C</span><br></pre></td></tr></table></figure>

<p>其实里头说了啥，现在不用太关心，需要看看这个方法是被谁调用了。</p>
<p>使用快捷键<code>Ctrl+X</code>可以查看那些地方调用了<code>getCloverPoint</code>这个方法。果不其然，找到了一个叫<code>DisplayPanel$$BuyItem</code>的方法，点进去看看。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">loc_5DA8C0</span><br><span class="line">LDR             W8, [X20,#0x34]</span><br><span class="line">MOV             X1, XZR</span><br><span class="line">NEG             W0, W8</span><br><span class="line">BL              SuperGameMaster$$getCloverPoint</span><br><span class="line">LDR             W0, [X21,#0x10]</span><br><span class="line">MOV             W1, #1</span><br><span class="line">MOV             X2, XZR</span><br><span class="line">BL              SuperGameMaster$$GetItem</span><br><span class="line">ADRP            X28, #off_EBE6A0@PAGE</span><br><span class="line">LDR             X28, [X28,#off_EBE6A0@PAGEOFF]</span><br><span class="line">MOV             X0, X19</span><br><span class="line">LDR             X1, [X28]</span><br><span class="line">BL              Component$$GetComponentInParent_10897408</span><br><span class="line">MOV             X21, X0</span><br><span class="line">CBNZ            X21, loc_5DA900</span><br></pre></td></tr></table></figure>

<p>在调用方法之前，这里有一个NEG操作。这句的意思就是把W8 * (-1)，然后赋值给W0，其实就是说W0就是W8的相反数。结合方法名称叫做<code>getCloverPoint</code>，可以大胆推测，买东西的时候就是“获取负数量的三叶草”。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">NEG             W0, W8</span><br></pre></td></tr></table></figure>

<p>为了证实猜想，进去另一个调用了<code>getCloverPoint</code>的方法看看。我选择了<code>IAPPanel$$IAP_Complete</code>，因为一看就知道这个方法就是内购完成后进行的操作。代码如下。显而易见这里所使用的就是<code>MOV W0, W22</code>了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">loc_51B294</span><br><span class="line">MOV             W0, W22</span><br><span class="line">MOV             X1, XZR</span><br><span class="line">BL              SuperGameMaster$$getCloverPoint</span><br><span class="line">CBZ             X21, loc_51B2B8</span><br></pre></td></tr></table></figure>

<p>那么目标很明确了，就是把刚刚那个NEG改成MOV，这样就是把每次购买时的商品价格直接加到玩家的三叶草上。</p>
<p>注：最后跟1.0.4的C#代码作比较，再次证实了猜想的正确性。</p>
<p>附上对应的C#代码</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">getCloverPoint</span>(<span class="params"><span class="built_in">int</span> num</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	SuperGameMaster.saveData.CloverPoint += num;</span><br><span class="line">	<span class="keyword">if</span> (num &gt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		SuperGameMaster.set_FlagAdd(Flag.Type.CLOVER_NUM, num);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">BuyItem</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	ShopDataFormat shopDataFormat = SuperGameMaster.sDataBase.get_ShopDB(<span class="keyword">this</span>.selectShopIndex);</span><br><span class="line">	ItemDataFormat itemDataFormat = SuperGameMaster.sDataBase.get_ItemDB_forId(shopDataFormat.itemId);</span><br><span class="line">	SuperGameMaster.getCloverPoint(-itemDataFormat.price);</span><br><span class="line">	SuperGameMaster.GetItem(shopDataFormat.itemId, <span class="number">1</span>);</span><br><span class="line">	<span class="keyword">base</span>.GetComponentInParent&lt;UIMaster&gt;().OnSave();</span><br><span class="line">	<span class="comment">//以下略</span></span><br></pre></td></tr></table></figure>

<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">IAP_Complete</span>(<span class="params"><span class="built_in">int</span> getId</span>)</span></span><br><span class="line"><span class="function"></span>	&#123;</span><br><span class="line">		<span class="built_in">int</span> num = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">switch</span> (getId)</span><br><span class="line">		&#123;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">			num = <span class="number">400</span>;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">			num = <span class="number">1000</span>;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">			num = <span class="number">1800</span>;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">			num = <span class="number">2800</span>;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		SuperGameMaster.getCloverPoint(num);</span><br><span class="line">	        <span class="comment">//以下略</span></span><br></pre></td></tr></table></figure>

<ol start="7">
<li>把目标代码转换成hex</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MOV             W0, W8</span><br></pre></td></tr></table></figure>

<p>随手一搜就有“Online ARM To Hex Converter”，那就再好不过了，直接丢进去转换即可，转换结果是<code>E003082A</code>。</p>
<ol start="8">
<li>替换原有hex</li>
</ol>
<p>回到IDA，鼠标选中需要修改的那行代码，在下面就能看到代码位置，我这里显示的是005DA8C8。</p>
<p>使用Hxd打开<code>libil2cpp.so</code>文件，<code>Ctrl+G</code>或者搜索 &gt; 跳转，然后输入刚刚获取的位置信息（005DA8C8）。</p>
<p>在此处你应该能看到<code>E0 03 08 4B</code>，对了，这个就是<code>NEG W0, W8</code>。</p>
<p>把光标移动到<code>E0 03 08 4B</code>的头部（E前面），然后直接输入<code>E003082A</code>即可，输入的时候会自动覆盖掉原来的内容。改完记得保存。</p>
<ol start="9">
<li>打包 &amp; 签名</li>
</ol>
<p>清理掉一些不必要的文件，例如IDA生成的文件，hxd生成的bak文件等等。</p>
<p>然后打包签名。</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar apktool.jar b ./frog_104</span><br></pre></td></tr></table></figure>

<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jarsigner -verbose -keystore myKeyStore -signedjar frog_162_signed.apk frog_162.apk myKeyStore</span><br></pre></td></tr></table></figure>

<p>安装APP，在进行新手教程的时候会需要买东西，此时三叶草不减反增，证明逆向成功！</p>
<ol start="12">
<li>收获</li>
</ol>
<p>这次花的时间稍微长一些，研究学习了从汇编码层面来修改逻辑。</p>
<ol start="13">
<li>参考链接</li>
</ol>
<ul>
<li><p><a target="_blank" rel="noopener" href="https://www.52pojie.cn/thread-982655-1-1.html">记录一次Unity3d-il2cpp游戏修改</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://developer.arm.com/keil-search">Keil-Search</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/0c6192da2fd0">ARM汇编之解惑条件标志，条件码，条件执行</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/cwcwj3069/article/details/7948078">ARM汇编指令(ARM寻址方式、汇编指令、伪指令)</a></p>
</li>
</ul>
<h2 id="0x03-神庙逃亡-v1-9-6-2019-09-03"><a href="#0x03-神庙逃亡-v1-9-6-2019-09-03" class="headerlink" title="0x03 神庙逃亡 v1.9.6 (2019/09/03)"></a>0x03 神庙逃亡 v1.9.6 (2019/09/03)</h2><p>本来想尝试逆向神庙逃亡最新版的，无奈从v1.10.0开始就对游戏进行了加密，因此挑选最后一个无加密的版本进行练习。</p>
<ol start="0">
<li>获取神庙逃亡v1.9.6版本</li>
</ol>
<p>网上一搜一大把，我下载之后重命名为<code>temple_196.apk</code>。</p>
<p>还是先进行如下常规步骤。</p>
<ol>
<li><p>首先将apk用<code>apktool</code>进行反编译</p>
</li>
<li><p>找到Assembly-CSharp.dll</p>
</li>
<li><p>使用dnSpy反编译找到的C#脚本</p>
</li>
<li><p>寻找目标</p>
</li>
</ol>
<p>这里搜索了<code>Buy</code>，然后发现了一个叫<code>BuyItem</code>的方法。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">BuyItem</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>	&#123;</span><br><span class="line">		<span class="built_in">int</span> num = <span class="keyword">this</span>.RecordManager.GetCoinCount(<span class="keyword">this</span>.PlayerManager.GetActivePlayer());</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.Price &lt;= num)</span><br><span class="line">		&#123;</span><br><span class="line">			num -= <span class="keyword">this</span>.Price;</span><br><span class="line">			<span class="keyword">this</span>.RecordManager.SetCoinCount(<span class="keyword">this</span>.PlayerManager.GetActivePlayer(), num);</span><br><span class="line">			<span class="keyword">if</span> (<span class="keyword">this</span>.Type == RecordManager.StoreItemType.kStoreItemDisableAds)</span><br><span class="line">			&#123;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="built_in">int</span> playerLevelForUpgradeType = <span class="keyword">this</span>.RecordManager.GetPlayerLevelForUpgradeType(<span class="keyword">this</span>.PlayerManager.GetActivePlayer(), <span class="keyword">this</span>.Type);</span><br><span class="line">			<span class="keyword">if</span> ((<span class="keyword">this</span>.Type == RecordManager.StoreItemType.kStoreItemCoinBonus || <span class="keyword">this</span>.Type == RecordManager.StoreItemType.kStoreItemVacuum || <span class="keyword">this</span>.Type == RecordManager.StoreItemType.kStoreItemInvincibility || <span class="keyword">this</span>.Type == RecordManager.StoreItemType.kStoreItemBoost) &amp;&amp; playerLevelForUpgradeType &gt;= <span class="number">7</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">this</span>.RecordManager.SetPlayerLevelForUpgradeType(<span class="keyword">this</span>.PlayerManager.GetActivePlayer(), <span class="keyword">this</span>.Type, <span class="number">6</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">this</span>.RecordManager.SetPlayerLevelForUpgradeType(<span class="keyword">this</span>.PlayerManager.GetActivePlayer(), <span class="keyword">this</span>.Type, playerLevelForUpgradeType + <span class="number">1</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">base</span>.SendMessageUpwards(<span class="string">&quot;AdjustCoins&quot;</span>);</span><br><span class="line">			<span class="keyword">this</span>.RecordManager.SaveRecords();</span><br><span class="line">			<span class="keyword">this</span>.Reconfigure();</span><br><span class="line">			AudioManager.Instance.PlayFX(AudioManager.Effects.cashRegister, <span class="number">1f</span>);</span><br><span class="line">			<span class="keyword">if</span> (<span class="keyword">this</span>.Type == RecordManager.StoreItemType.kStoreItemAngelWings &amp;&amp; playerLevelForUpgradeType == <span class="number">0</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">this</span>.AlertView.ShowAlert(Strings.Txt(<span class="string">&quot;StoreItemResurrectionWingsPopupTitle&quot;</span>), Strings.Txt(<span class="string">&quot;StoreItemResurrectionWingsPopupText&quot;</span>), Strings.Txt(<span class="string">&quot;Ok&quot;</span>), <span class="literal">null</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (<span class="keyword">this</span>.Type == RecordManager.StoreItemType.kStoreItemPermaWings &amp;&amp; playerLevelForUpgradeType == <span class="number">0</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">this</span>.AlertView.ShowAlert(Strings.Txt(<span class="string">&quot;StoreItemPermaWingsPopupTitle&quot;</span>), Strings.Txt(<span class="string">&quot;StoreItemPermaWingsPopupText&quot;</span>), Strings.Txt(<span class="string">&quot;Ok&quot;</span>), <span class="literal">null</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (<span class="keyword">this</span>.Type == RecordManager.StoreItemType.kStoreItemHeadStart &amp;&amp; playerLevelForUpgradeType == <span class="number">0</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">this</span>.AlertView.ShowAlert(Strings.Txt(<span class="string">&quot;StoreItemHeadStartPopupTitle&quot;</span>), Strings.Txt(<span class="string">&quot;StoreItemHeadStartPopupText&quot;</span>), Strings.Txt(<span class="string">&quot;Ok&quot;</span>), <span class="literal">null</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (<span class="keyword">this</span>.Type == RecordManager.StoreItemType.kStoreItemHeadStartMega &amp;&amp; playerLevelForUpgradeType == <span class="number">0</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">this</span>.AlertView.ShowAlert(Strings.Txt(<span class="string">&quot;StoreItemHeadStartMegaPopupTitle&quot;</span>), Strings.Txt(<span class="string">&quot;StoreItemHeadStartMegaPopupText&quot;</span>), Strings.Txt(<span class="string">&quot;Ok&quot;</span>), <span class="literal">null</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (<span class="keyword">this</span>.Class == StoreItem.StoreItemClass.Character)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">this</span>.ActivateCharacter(<span class="keyword">this</span>.Type);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (<span class="keyword">this</span>.Class == StoreItem.StoreItemClass.Wallpaper)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">this</span>.GrabWallpaper(<span class="keyword">this</span>.Type);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">this</span>.AlertView.ShowAlert(Strings.Txt(<span class="string">&quot;StoreItemNotEnoughCoinsTitle&quot;</span>), Strings.Txt(<span class="string">&quot;StoreItemNotEnoughCoinsText&quot;</span>), Strings.Txt(<span class="string">&quot;No&quot;</span>), Strings.Txt(<span class="string">&quot;Yes&quot;</span>), <span class="literal">null</span>, <span class="built_in">delegate</span>()</span><br><span class="line">			&#123;</span><br><span class="line">				StoreGUI.Instance.HideAll();</span><br><span class="line">				VCGUI.Instance.SlideIn(StoreGUI.Instance);</span><br><span class="line">			&#125;);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>关键在这一小段。游戏使用GetCoinCount方法获取金币数量，然后跟价格作比较，如果金币大于等于价格就扣除。这里有很多思路，比如可以把扣钱改成加钱，我这里走的是修改获取金币的方法的返回值的路线。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">int</span> num = <span class="keyword">this</span>.RecordManager.GetCoinCount(<span class="keyword">this</span>.PlayerManager.GetActivePlayer());</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.Price &lt;= num)</span><br><span class="line">		&#123;</span><br><span class="line">			num -= <span class="keyword">this</span>.Price;</span><br></pre></td></tr></table></figure>

<p>那就跟进去GetCoinCount方法看看。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">int</span> <span class="title">GetCoinCount</span>(<span class="params"><span class="built_in">int</span> playerId</span>)</span></span><br><span class="line"><span class="function"></span>	&#123;</span><br><span class="line">		RecordManager.cPlayerRecord cPlayerRecord = <span class="keyword">this</span>.FindPlayerRecord(playerId);</span><br><span class="line">		<span class="keyword">return</span> (cPlayerRecord == <span class="literal">null</span>) ? <span class="number">0</span> : cPlayerRecord.coinCount;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>这里很明显了，直接把<code>return (cPlayerRecord == null) ? 0 : cPlayerRecord.coinCount;</code>替换成<code>return 99999;</code>即可。</p>
<p>点击需要修改的那行代码，右键编辑IL指令，然后直接删除高亮指令（就是选中的代码），新建指令<code>idc.i4 99999</code>和<code>ret</code>。</p>
<ol start="5">
<li><p>保存，签名，打包，真机测试成功。</p>
</li>
<li><p>收获</p>
</li>
</ol>
<p>这次花的时间就非常短了，有了之前的经验，这次可以很快定位到目标并且完成修改。其实除了修改金币，还可以尝试修改别的东西，比如各种道具效果。</p>
<ol start="7">
<li>后记</li>
</ol>
<p>试着改了下道具效果，没有测试，但是地方应该是对了。</p>
<p>搜索<code>Boost</code>，发现有个方法叫<code>StartBoost</code>，点进去看看。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">StartBoost</span>(<span class="params"><span class="built_in">float</span> distance, <span class="built_in">bool</span> isMega</span>)</span></span><br><span class="line"><span class="function"></span>	&#123;</span><br><span class="line">		DebugEx.Log(<span class="string">&quot;PICKUP: BOOST of &quot;</span> + distance);</span><br><span class="line">		<span class="built_in">bool</span> hasBoost = <span class="keyword">this</span>.HasBoost;</span><br><span class="line">		<span class="keyword">this</span>.HasBoost = <span class="literal">true</span>;</span><br><span class="line">		<span class="keyword">this</span>.IsMegaBoost = isMega;</span><br><span class="line">		<span class="keyword">if</span> (!hasBoost)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">this</span>.VelocityBeforeBoost = ((!<span class="keyword">this</span>.IsMegaBoost) ? <span class="keyword">this</span>.GetRunVelocity() : <span class="keyword">this</span>.MaxRunVelocity);</span><br><span class="line">			<span class="keyword">this</span>.StartInvcibility(<span class="number">4f</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">this</span>.BoostDistanceLeft = distance + <span class="number">50f</span>;</span><br><span class="line">		<span class="keyword">this</span>.TimeSinceLastPowerup = <span class="number">0f</span>;</span><br><span class="line">		<span class="keyword">this</span>.StumbleKillTimer += <span class="number">10f</span>;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>右键分析被谁调用，发现有个叫<code>UseHeadStartMega</code>，感觉像是我想要的，点进去看看。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">UseHeadStartMega</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>	&#123;</span><br><span class="line">		<span class="keyword">if</span> (!<span class="keyword">this</span>.IsPaused &amp;&amp; !<span class="keyword">this</span>.IsInCountdown &amp;&amp; !<span class="keyword">this</span>.IsGameOver &amp;&amp; !<span class="keyword">this</span>.IsTutorialMode &amp;&amp; !<span class="keyword">this</span>.IsIntroScene &amp;&amp; !<span class="keyword">this</span>.GamePlayer.IsDead &amp;&amp; !<span class="keyword">this</span>.GamePlayer.IsFalling &amp;&amp; <span class="keyword">this</span>.DistanceTraveled &gt; <span class="keyword">this</span>.HeadStartStartDistance &amp;&amp; <span class="keyword">this</span>.DistanceTraveled &lt; <span class="keyword">this</span>.HeadStartEndDistance)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">this</span>.Audio.PlayFX(AudioManager.Effects.bonusPickup, <span class="number">1f</span>);</span><br><span class="line">			<span class="keyword">this</span>.RecordManager.AdjustPlayerLevelForUpgradeType(<span class="keyword">this</span>.PlayerManager.GetActivePlayer(), RecordManager.StoreItemType.kStoreItemHeadStartMega, <span class="number">-1</span>);</span><br><span class="line">			<span class="keyword">this</span>.RecordManager.SaveRecords();</span><br><span class="line">			<span class="built_in">float</span> distance = <span class="keyword">this</span>.HeadStartMegaBoostDistance - <span class="keyword">this</span>.DistanceTraveled;</span><br><span class="line">			<span class="keyword">this</span>.GamePlayer.StartBoost(distance, <span class="literal">false</span>);</span><br><span class="line">			<span class="keyword">this</span>.UsedHeadStart = <span class="literal">true</span>;</span><br><span class="line">			<span class="keyword">if</span> (!<span class="keyword">this</span>.UsedPowers)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">this</span>.UsedPowers = <span class="literal">true</span>;</span><br><span class="line">				<span class="keyword">this</span>.ScoreWhenFirstUsedPowers = <span class="keyword">this</span>.GamePlayer.Score;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>然后发现有个字段叫<code>HeadStartMegaBoostDistance</code>，这个应该就是道具冲刺的距离了，点进去看看。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">float</span> HeadStartMegaBoostDistance = <span class="number">2350f</span>;</span><br></pre></td></tr></table></figure>

<p>如果觉得原本的冲刺距离不够爽，那就改成235000f好了~</p>
<h2 id="0x04-神庙逃亡2-v1-12-1-2019-09-05"><a href="#0x04-神庙逃亡2-v1-12-1-2019-09-05" class="headerlink" title="0x04 神庙逃亡2 v1.12.1 (2019/09/05)"></a>0x04 神庙逃亡2 v1.12.1 (2019/09/05)</h2><p>既然逆向了神庙逃亡1，那就顺手把神庙逃亡2也逆向了吧~</p>
<p>这次选择了老旧的1.12.1版本，因为这个版本没有进行加密。</p>
<ol start="0">
<li>获取神庙逃亡v1.12.1版本</li>
</ol>
<p>网上一搜一大把，我下载之后重命名为<code>temple2_1121.apk</code>。</p>
<p>先进行常规步骤：用<code>apktool</code>进行反编译，找到Assembly-CSharp.dll，使用dnSpy反编译找到的C#脚本，寻找目标。</p>
<p>注：后面为了节约时间，常规步骤会直接略过不写。</p>
<p>在神庙逃亡2中，可以通过点击“关注Facebook”和“关注Twitter”来获取一定的资源，我的目标就是把这两个按钮变成无限提款机。</p>
<ol>
<li>修改“关注Facebook”相关方法</li>
</ol>
<p>这里直接搜索方法<code>Facebook</code>，然后发现了一个叫<code>PerformLikeOnFacebook</code>的方法。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">PerformLikeOnFacebook</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>	&#123;</span><br><span class="line">		UIConfirmDialog.onNegativeResponse -= <span class="keyword">this</span>.CanceledLike;</span><br><span class="line">		UIConfirmDialog.onPositiveResponse -= <span class="keyword">this</span>.PerformLikeOnFacebook;</span><br><span class="line">		EtceteraAndroid.showWebView(<span class="string">&quot;http://www.facebook.com/Tem****un&quot;</span>);</span><br><span class="line">		GameProfile.SharedInstance.ProfileData.HasLikedOnFacebook = <span class="literal">true</span>;</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.FacebookGiftType == CostType.Coin)</span><br><span class="line">		&#123;</span><br><span class="line">			GameProfile.SharedInstance.Player.coinCount += <span class="keyword">this</span>.FacebookGiftAmount;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.FacebookGiftType == CostType.Special)</span><br><span class="line">		&#123;</span><br><span class="line">			GameProfile.SharedInstance.Player.specialCurrencyCount += <span class="keyword">this</span>.FacebookGiftAmount;</span><br><span class="line">		&#125;</span><br><span class="line">		GameProfile.SharedInstance.Serialize();</span><br><span class="line">		<span class="keyword">this</span>.FillInFreeOffers();</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>关键逻辑很明显，判断礼物类型，然后根据类型发放对应数额。但是既然要重复领取，总不能每次都弹出Facebook页面。所以直接把<code>showWebView</code>对应的IL指令删掉即可。</p>
<p>然后看到下一行是<code>HasLikedOnFacebook = true;</code>，这个很明显就是用来记录是否领取过的flag，当然是要改成false啦。编辑IL指令，把<code>idc.i4.1</code>改成<code>idc.i4.0</code>即可。</p>
<p>其实到这里就可以直接把<code>this.FacebookGiftAmount</code>替换成想要的数字就可以了，因为<code>this.FacebookGiftType</code>大概率不是<code>Coin</code>就是<code>Special</code>，但是我还是想直接把<code>if (this.FacebookGiftType == CostType.Coin)</code>替换成<code>if(true)</code>。因此单独把关键段落拿出来并看看IL代码。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>.FacebookGiftType == CostType.Coin)</span><br><span class="line">		&#123;</span><br><span class="line">			GameProfile.SharedInstance.Player.coinCount += <span class="keyword">this</span>.FacebookGiftAmount;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.FacebookGiftType == CostType.Special)</span><br><span class="line">		&#123;</span><br><span class="line">			GameProfile.SharedInstance.Player.specialCurrencyCount += <span class="keyword">this</span>.FacebookGiftAmount;</span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure>

<p>我把IL代码加了空行，这样可以跟C#代码对应起来。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">14	003C	ldarg.0</span><br><span class="line">15	003D	ldfld	    valuetype CostType UIFreeStuffViewController::FacebookGiftType</span><br><span class="line">16	0042	brtrue	    26 (0068) ldarg.0 </span><br><span class="line"></span><br><span class="line">17	0047	ldsfld	    class GameProfile GameProfile::SharedInstance</span><br><span class="line">18	004C	callvirt	instance class PlayerStats GameProfile::get_Player()</span><br><span class="line">19	0051	dup</span><br><span class="line">20	0052	ldfld	    int32 PlayerStats::coinCount</span><br><span class="line">21	0057	ldarg.0</span><br><span class="line">22	0058	ldfld	    int32 UIFreeStuffViewController::FacebookGiftAmount</span><br><span class="line">23	005D	add</span><br><span class="line">24	005E	stfld	    int32 PlayerStats::coinCount</span><br><span class="line">25	0063	br	        38 (0090) ldsfld class GameProfile GameProfile::SharedInstance</span><br><span class="line"></span><br><span class="line">26	0068	ldarg.0</span><br><span class="line">27	0069	ldfld	    valuetype CostType UIFreeStuffViewController::FacebookGiftType</span><br><span class="line">28	006E	ldc.i4.1</span><br><span class="line">29	006F	bne.un	    38 (0090) ldsfld class GameProfile GameProfile::SharedInstance</span><br><span class="line"></span><br><span class="line">30	0074	ldsfld	    class GameProfile GameProfile::SharedInstance</span><br><span class="line">31	0079	callvirt	instance class PlayerStats GameProfile::get_Player()</span><br><span class="line">32	007E	dup</span><br><span class="line">33	007F	ldfld	    int32 PlayerStats::specialCurrencyCount</span><br><span class="line">34	0084	ldarg.0</span><br><span class="line">35	0085	ldfld	    int32 UIFreeStuffViewController::FacebookGiftAmount</span><br><span class="line">36	008A	add</span><br><span class="line">37	008B	stfld	    int32 PlayerStats::specialCurrencyCount</span><br></pre></td></tr></table></figure>

<p>先看源代码第一句<code>if (this.FacebookGiftType == CostType.Coin)</code>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">14	003C	ldarg.0</span><br><span class="line">15	003D	ldfld	valuetype CostType UIFreeStuffViewController::FacebookGiftType</span><br><span class="line">16	0042	brtrue	26 (0068) ldarg.0 </span><br></pre></td></tr></table></figure>

<p>这个<code>ldarg.0</code>就是this，下面这个<code>ldfld</code>很明显就是比较的内容，<code>ldfld</code>顾名思义就是“Load Field”，作用大概就是获取对象的值（Push the value of field of object (or value type) obj, onto the stack.）。<code>brtrue</code>顾名思义就是“Branch True”，就是如果为真跳转到指定目标（Branch to target if value is non-zero (true).）</p>
<p>直接改成下面这样，这时候C#代码就是<code>if(true)</code>。brfalse就是如果为假跳转到指定目标（Branch to target if value is zero (false).）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">14	003C	ldc.i4.1</span><br><span class="line">15	003D	brfalse	25 (0063) ldarg.0 </span><br></pre></td></tr></table></figure>

<p>接下来，我想让这个这个true分支中给钻石而不是给金币，那么就可以看看那一段的关键IL代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">20	0052	ldfld	int32 PlayerStats::coinCount</span><br><span class="line">21	0057	ldarg.0</span><br><span class="line">22	0058	ldfld	int32 UIFreeStuffViewController::FacebookGiftAmount</span><br><span class="line">23	005D	add</span><br><span class="line">24	005E	stfld	int32 PlayerStats::coinCount</span><br></pre></td></tr></table></figure>

<p>用大白话说就是取出coinCount，取出FacebookGiftAmount，两个相加，然后赋值给coinCount。</p>
<p>stfld应该就是赋值（Replace the value of field of the object obj with value.）。</p>
<p>要修改ldfld内容的话也很容易。首先单击<code>20    0052    ldfld    int32 PlayerStats::coinCount</code>这行，选择“字段”，搜索<code>specialCurrencyCount</code>，在下方搜索结果选中，点击确定即可。</p>
<p>最后结果就是下面这样，输入<code>ldc.i4    888888</code>会自动被转换成<code>ldc.i4    0xD9038</code>。此时C#代码是<code>GameProfile.SharedInstance.Player.specialCurrencyCount += 888888;</code>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">19	004D	ldfld	int32 PlayerStats::specialCurrencyCount</span><br><span class="line">20	0052	ldc.i4	0xD9038</span><br><span class="line">21	0057	add</span><br><span class="line">22	0058	stfld	int32 PlayerStats::specialCurrencyCount</span><br></pre></td></tr></table></figure>

<p>这里针对点击“关注Facebook”按钮的修改就完成了。修改后的这个方法的C#代码如下：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">PerformLikeOnFacebook</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>	&#123;</span><br><span class="line">		UIConfirmDialog.onNegativeResponse -= <span class="keyword">this</span>.CanceledLike;</span><br><span class="line">		UIConfirmDialog.onPositiveResponse -= <span class="keyword">this</span>.PerformLikeOnFacebook;</span><br><span class="line">		GameProfile.SharedInstance.ProfileData.HasLikedOnFacebook = <span class="literal">false</span>;</span><br><span class="line">		<span class="keyword">if</span> (<span class="literal">true</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			GameProfile.SharedInstance.Player.specialCurrencyCount += <span class="number">888888</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.FacebookGiftType == CostType.Special)</span><br><span class="line">		&#123;</span><br><span class="line">			GameProfile.SharedInstance.Player.specialCurrencyCount += <span class="keyword">this</span>.FacebookGiftAmount;</span><br><span class="line">		&#125;</span><br><span class="line">		GameProfile.SharedInstance.Serialize();</span><br><span class="line">		<span class="keyword">this</span>.FillInFreeOffers();</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>修改“关注Twitter”相关方法</li>
</ol>
<p>方法是跟修改“关注Facebook”完全一样的。</p>
<p>原始的<code>PerformLikeOnTwitter</code>方法如下：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">PerformLikeOnTwitter</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>	&#123;</span><br><span class="line">		UIConfirmDialog.onNegativeResponse -= <span class="keyword">this</span>.CanceledFollow;</span><br><span class="line">		UIConfirmDialog.onPositiveResponse -= <span class="keyword">this</span>.PerformLikeOnTwitter;</span><br><span class="line">		EtceteraAndroid.showWebView(<span class="string">&quot;http://twitter.com/tem****un&quot;</span>);</span><br><span class="line">		GameProfile.SharedInstance.ProfileData.HasLikedOnTwitter = <span class="literal">true</span>;</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.TwitterGiftType == CostType.Coin)</span><br><span class="line">		&#123;</span><br><span class="line">			GameProfile.SharedInstance.Player.coinCount += <span class="keyword">this</span>.TwitterGiftAmount;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.TwitterGiftType == CostType.Special)</span><br><span class="line">		&#123;</span><br><span class="line">			GameProfile.SharedInstance.Player.specialCurrencyCount += <span class="keyword">this</span>.TwitterGiftAmount;</span><br><span class="line">		&#125;</span><br><span class="line">		GameProfile.SharedInstance.Serialize();</span><br><span class="line">		<span class="keyword">this</span>.FillInFreeOffers();</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>修改之后应该是下面这样。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">PerformLikeOnTwitter</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>	&#123;</span><br><span class="line">		UIConfirmDialog.onNegativeResponse -= <span class="keyword">this</span>.CanceledFollow;</span><br><span class="line">		UIConfirmDialog.onPositiveResponse -= <span class="keyword">this</span>.PerformLikeOnTwitter;</span><br><span class="line">		GameProfile.SharedInstance.ProfileData.HasLikedOnTwitter = <span class="literal">false</span>;</span><br><span class="line">		<span class="keyword">if</span> (<span class="literal">true</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			GameProfile.SharedInstance.Player.coinCount += <span class="number">999999</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.TwitterGiftType == CostType.Special)</span><br><span class="line">		&#123;</span><br><span class="line">			GameProfile.SharedInstance.Player.specialCurrencyCount += <span class="keyword">this</span>.TwitterGiftAmount;</span><br><span class="line">		&#125;</span><br><span class="line">		GameProfile.SharedInstance.Serialize();</span><br><span class="line">		<span class="keyword">this</span>.FillInFreeOffers();</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>改开局冲刺距离</li>
</ol>
<p>这个很简单，搜索“Mega”就找到一个叫<code>OnMegaHeadStart</code>的方法，如下所示。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnMegaHeadStart</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>	&#123;</span><br><span class="line">		GameProfile.SharedInstance.Player.coinCount -= GameProfile.SharedInstance.Player.GetMegaHeadStartCost();</span><br><span class="line">		GamePlayer.SharedInstance.StartBoost();</span><br><span class="line">		GamePlayer.SharedInstance.BoostDistanceLeft = <span class="number">2500f</span>;</span><br><span class="line">		GameController.SharedInstance.HeadStartsThisRun++;</span><br><span class="line">		TRAnalytics.logEvent(<span class="string">&quot;MegaHeadStart&quot;</span>, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.headStartRoot != <span class="literal">null</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			NGUITools.SetActive(<span class="keyword">this</span>.headStartRoot.gameObject, <span class="literal">false</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.megaHeadStartRoot != <span class="literal">null</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			NGUITools.SetActive(<span class="keyword">this</span>.megaHeadStartRoot.gameObject, <span class="literal">false</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		AudioManager.SharedInstance.PlayFX(AudioManager.Effects.cashRegister, <span class="number">1f</span>, <span class="number">1f</span>);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>很明显，直接修改<code>BoostDistanceLeft</code>即可。</p>
<ol start="4">
<li>内购</li>
</ol>
<p>内购其实也不难，毕竟资源发放逻辑在本地。不够由于技术比较菜，找了半天才发现目标。</p>
<p>突破口在于断网尝试内购的字符串“Cannot connect to the internet.”</p>
<p>直接搜索“Cannot Connect”会发现叫做<code>ShowNetworkErrorDialog</code>的方法。点进去看看。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ShowNetworkErrorDialog</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>	&#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.confirmDialog == <span class="literal">null</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">this</span>.confirmDialog.ShowInfoDialog(<span class="string">&quot;Error!&quot;</span>, <span class="string">&quot;Cannot connect to\nthe internet.&quot;</span>, <span class="string">&quot;Close&quot;</span>);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>嗯，这个就是蹦个对话框出来，跟观察到的相符。看看被谁调用了，发现有两个可疑方法，<code>TryRealMoneyPurchase</code>和<code>OnBuyIAP</code>。</p>
<p>观察发现关键代码如下：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.PurchaseSuccessfulWithProductID(charData.ProductId, <span class="built_in">string</span>.Empty);</span><br></pre></td></tr></table></figure>

<p>接下来就简单了，直接修改对应逻辑，让上面两个方法直接执行“购买成功”的代码。修改后的代码就不贴了。</p>
<ol start="5">
<li><p>保存，签名，打包，真机测试成功。</p>
</li>
<li><p>收获</p>
</li>
</ol>
<p>这次学习了更加多的IL指令。而且通过逆向发现，内购其实就是跟内购服务通信之后，通过返回的内容决定是否发放对应物品。。。。。。比想象中的机制要简单很多啊~</p>
<ol start="7">
<li>参考链接</li>
</ol>
<ul>
<li><p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/dotnet/api/system.reflection.emit.opcodes?view=netframework-4.8">OpCodes Class (System.Reflection.Emit) | Microsoft Docs</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/List_of_CIL_instructions">List of CIL instructions - Wikipedia</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/1785372/why-do-i-have-to-do-ldarg-0-before-calling-a-field-in-msil">Why do I have to do ldarg.0 before calling a field in MSIL?</a></p>
</li>
</ul>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/hack/" rel="tag"># hack</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/tech/pyqt5-designer-tutorial.html" rel="prev" title="PyQt5（designer）入门教程">
      <i class="fa fa-chevron-left"></i> PyQt5（designer）入门教程
    </a></div>
      <div class="post-nav-item">
    <a href="/announcement/hello-world-hexo.html" rel="next" title="Hello World (Hexo)">
      Hello World (Hexo) <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#0x00-%E8%BD%AF%E4%BB%B6%E6%B8%85%E5%8D%95"><span class="nav-number">1.</span> <span class="nav-text">0x00 软件清单</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x01-%E6%97%85%E8%A1%8C%E9%9D%92%E8%9B%99-v1-0-4-2019-09-02"><span class="nav-number">2.</span> <span class="nav-text">0x01 旅行青蛙 v1.0.4 (2019&#x2F;09&#x2F;02)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x02-%E6%97%85%E8%A1%8C%E9%9D%92%E8%9B%99-v1-6-2-2019-09-03"><span class="nav-number">3.</span> <span class="nav-text">0x02 旅行青蛙 v1.6.2 (2019&#x2F;09&#x2F;03)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x03-%E7%A5%9E%E5%BA%99%E9%80%83%E4%BA%A1-v1-9-6-2019-09-03"><span class="nav-number">4.</span> <span class="nav-text">0x03 神庙逃亡 v1.9.6 (2019&#x2F;09&#x2F;03)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x04-%E7%A5%9E%E5%BA%99%E9%80%83%E4%BA%A12-v1-12-1-2019-09-05"><span class="nav-number">5.</span> <span class="nav-text">0x04 神庙逃亡2 v1.12.1 (2019&#x2F;09&#x2F;05)</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="oscarcx123"
      src="/uploads/avatar.jpg">
  <p class="site-author-name" itemprop="name">oscarcx123</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">101</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/oscarcx123" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;oscarcx123" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">oscarcx123</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
      <span class="post-meta-item-text">站点总字数：</span>
    <span title="站点总字数">162k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span class="post-meta-item-text">站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">2:27</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v5.2.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">主题 – <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v7.7.1
  </div><script color="0,0,255" opacity="0.5" zIndex="-1" count="99" src="https://cdn.jsdelivr.net/npm/canvas-nest.js@1/dist/canvas-nest.js"></script>


        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/pjax/pjax.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>

  <script>
var pjax = new Pjax({
  selectors: [
    'head title',
    '#page-configurations',
    '.content-wrap',
    '.post-toc-wrap',
    '#pjax'
  ],
  switches: {
    '.post-toc-wrap': Pjax.switches.innerHTML
  },
  analytics: false,
  cacheBust: false,
  scrollTo : !CONFIG.bookmark.enable
});

window.addEventListener('pjax:success', () => {
  document.querySelectorAll('script[pjax], script#page-configurations, #pjax script').forEach(element => {
    var code = element.text || element.textContent || element.innerHTML || '';
    var parent = element.parentNode;
    parent.removeChild(element);
    var script = document.createElement('script');
    if (element.id) {
      script.id = element.id;
    }
    if (element.className) {
      script.className = element.className;
    }
    if (element.type) {
      script.type = element.type;
    }
    if (element.src) {
      script.src = element.src;
      // Force synchronous loading of peripheral JS.
      script.async = false;
    }
    if (element.getAttribute('pjax') !== null) {
      script.setAttribute('pjax', '');
    }
    if (code !== '') {
      script.appendChild(document.createTextNode(code));
    }
    parent.appendChild(script);
  });
  NexT.boot.refresh();
  // Define Motion Sequence & Bootstrap Motion.
  if (CONFIG.motion.enable) {
    NexT.motion.integrator
      .init()
      .add(NexT.motion.middleWares.subMenu)
      .add(NexT.motion.middleWares.postList)
      .bootstrap();
  }
  NexT.utils.updateSidebarPosition();
});
</script>




  















    <div id="pjax">
  

  

    </div>
</body>
</html>
